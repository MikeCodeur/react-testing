# mocker les requÃªtes HTTP
### ğŸ’¡ mocker les requÃªtes HTTP

## ğŸ“ Tes notes

Detaille ce que tu as appris ici `src/exercise/05.md`ouÂ surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les application React il y a Ã©normÃ©ment de composants qui appelle des API HTTP. Il est nÃ©cessaire de tester ce comportement. Il est prÃ©fÃ©rable d'Ã©viter d'appeler un vrai serveur pour Ã©viter des problÃ¨mes de configuration, Ã©tats des donnÃ©es etc ...  A la place il est possible d'utiliser des serveur mock.  Il s'agit d'une simulation de serveur embarquÃ© dans notre projet. on peut dÃ©finir le comportement des requÃªtes et des rÃ©ponses. Un utilitaire super intÃ©ressant Ã  utiliser est [mswjs : mock service worker](https://mswjs.io/)

```jsx
import { rest } from 'msw'
import { setupServer } from 'msw/node'
const server = setupServer(
  // Describe the requests to mock.
  rest.get('/book/:bookId', (req, res, ctx) => {
    return res(
      ctx.json({
        title: 'Lord of the Rings',
        author: 'J. R. R. Tolkien',
      }),
    )
  }),
)
beforeAll(() => {
  // Establish requests interception layer before all tests.
  server.listen()
})
afterAll(() => {
  // Clean up after all tests are done, preventing this
  // interception layer from affecting irrelevant tests.
  server.close()
})
test('renders a book data', () => {
  // Render components, perform requests, API communication is covered.
})
```

## Exercice

Dans cet exercice nous avons un composant `<LoginForm />` qui fait un appel HTTP vers une API d'authentification lorsque l'on clique sur `"Connexion"`.  Lorsque l'utilisateur est connectÃ© le composant affiche  "Bonjour username". 

Dans cet exercice tu vas devoir mettre en place le `serveur mock`. Le serveur vÃ©rifie la prÃ©sence de `username` et `password` et simule un delay de 100ms (`ctx.delay(100)`). et vÃ©rifier que le composant affiche le bon message un simulant un connexion. Comme les appelle HTTP sont asynchrone on simulera une attente avant d'appeler les assertions. "testing-library" nous fournis `waitFor`

ğŸ“‘ Documentation de [waitFor](https://testing-library.com/docs/dom-testing-library/api-async/)

## Bonus

### 1. ğŸš€ waitForElementToBeRemoved

PlutÃ´t que d'attendre quelques millisecondes avec `waitFor.` qui n'est pas un pattern fiable et optimisÃ©e nous allons faire diffÃ©remment. Dans notre composant nous affichons *'chargement...'* quand l'appel HTTP est en cours. nous pouvons alors  utiliser `waitForElementToBeRemoved` pour detecter quand ce texte va disparaitre. Utilise `waitForElementToBeRemoved` dans cet exercice

ğŸ“‘ Documentation vers [waitForElementToBeRemoved](https://testing-library.com/docs/dom-testing-library/api-async/#waitforelementtoberemoved)

### 2. ğŸš€ rÃ©utilisation des requÃªtes HTTP Mock

PlutÃ´t que de redÃ©finir sans cesse `setupServer` avec les `requests handler`, on peut les externaliser dans un fichier Ã  part puis les importer au besoins sur nos tests.

Utilise `import mockHandlers from '../../test/mock-handlers'`

```jsx
import mockHandlers from '../../test/mock-handlers'
const server = setupServer(...mockHandlers)
```

### 3. ğŸš€ VÃ©rifier les erreurs

Fais un test qui permet de s'assurer des bon messages d'erreur. Par exemple lorsque le mot de passe n'est pas fournis, vÃ©rifie la prÃ©sence du message : `"le password est obligatoire"`

### 4. ğŸš€ Snapshot

Il est parfois rÃ©barbatif de mettre Ã  jour tous les messages d'erreurs, les snapshot de jest permettent de rÃ©gÃ©nÃ©rer le code attendu facilement. Dans cet exercice met Ã  jour le message d'erreur cotÃ© serveur et utilise  `toMatchInlineSnapshot` pour rÃ©gÃ©nÃ©rer le code

ğŸ“‘ lien vers la doc de [Jest snapshot](https://jestjs.io/fr/docs/snapshot-testing)

### 5. ğŸš€ rÃ©initialiser les servers handlers

Dans cet exercice nous voulons tester le cas d'un autre type d'erreur par par exemple un : *503	Service Unavailable.* Nous avons donc besoin d'un handler particulier. Dans cet exercice redige une nouveau test qui permet de tester une erreur 503. (sans invalider les tester prÃ©cÃ©dents). Utilise `resetHandlers` du server, `server.use` pour ajouter un handler dans le test  et `afterEach` de jest.

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-react-avis).